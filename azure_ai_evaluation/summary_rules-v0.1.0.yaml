summaryRules:
  - name: "Online-Experimentation-GenAI-eval"
    binSize: 20
    destinationTable: AppEvents_CL
    description: "Summary rule definition for Azure AI evaluation-based GenAI metrics."
    query: |
      let runid_to_targetingid = AppDependencies
      | where Properties has 'TargetingId' and Properties has 'gen_ai.thread.run.id'
      | project RunId = tostring(Properties['gen_ai.thread.run.id']), TargetingId = tostring(Properties['TargetingId']);
      AppTraces
      | where Message == "gen_ai.evaluation.result"
      | extend RunId = tostring(Properties['gen_ai.thread.run.id'])
      | join kind=leftouter runid_to_targetingid on RunId
      | project Name = Message,
          TimeGenerated,
          ItemCount,
          Properties= pack("gen_ai.evaluation.score", todouble(Properties["gen_ai.evaluation.score"]),
          "gen_ai.evaluator.name", tostring(Properties["gen_ai.evaluator.name"]),
          "gen_ai.usage.input_tokens", toint(Properties["gen_ai.usage.input_tokens"]),
          "gen_ai.usage.output_tokens", toint(Properties["gen_ai.usage.output_tokens"]),
          "TargetingId", TargetingId)
